name: Build Packer images
on:
  workflow_call:
    secrets:
      auto_commit_user:
        required: true
      auto_commit_mail:
        required: true
      auto_commit_pwd:
        required: true
      registry_user:
        required: true
      registry_password:
        required: true
      nexus_publisher_user:
        required: true
      nexus_publisher_password:
        required: true
      gh_token:
        required: true

jobs:
  Validate-boostrap-configs:
    runs-on: integration-pipeline
    steps:
    - name: Checkout
      uses: actions/checkout@v3

    - name: Validate Manifest
      shell: bash
      run: |
            yamllint product-manifest.yaml
            cat product-manifest.yaml
      
  Build-Spawner:
    needs: [Validate-boostrap-configs]
    runs-on: integration-pipeline
    steps:
    - name: Checkout
      uses: actions/checkout@v3

    - name: Validate Manifest
      shell: bash
      run: |
            cat product-manifest.yaml
  
  Build-Simulator:
    needs: [Validate-boostrap-configs]
    runs-on: ubuntu-20.04
    steps:
    - name: Checkout
      uses: actions/checkout@v3

    - name: Validate Manifest
      shell: bash
      run: |
            cat product-manifest.yaml

  publish:
    needs: [Build-Spawner, Build-Simulator]
    runs-on: ubuntu-20.04
    steps:
    - name: Checkout
      uses: actions/checkout@v3

    - name: Validate Manifest
      shell: bash
      run: |
            cat product-manifest.yaml